<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Gender Square</title>
    <link rel="icon" href="./favicon.ico" />
    <script src="./cardinal-spline-js/curve.min.js"></script>
    <meta name="author" content="bbrk24" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        overflow: hidden;
      }
      input, textarea {
        font-size: 1rem;
      }
      .visible {
        visibility: visible;
        opacity: 1;
      }
      .hidden {
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s 2s, opacity 2s linear;
      }
      #url {
        background-color: lightGray;
        border-radius: 5px;
        padding: 5px;
        width: fit-content;
        font-family: 'Courier New', Courier, monospace;
        border: none;
        margin-top: 5px;
        max-width: calc(100vw - 32px);
      }
      #square {
        background-image: url('./gradient.png');
        background-size: 100%;
      }
      #tension {
        min-width: 2em;
      }
      #url-button {
        margin-top: 1em;
      }
    </style>
  </head>
  <body>
    <canvas width="320" height="320" id="square"></canvas>
    <div>
      <div>
        <button onclick="removePoint()">-</button>
        Points: <span id="point-count"></span>
        <button onclick="addPoint()">+</button>
      </div>
      <div>
        <label for="tension">Tension:</label>
        <input type="number" min="0" max="1" id="tension" oninput="redraw()" />
      </div>
      <div>
        <button id="url-button" onclick="saveURL()">Generate URL</button>
        <br />
        <textarea onclick="copyURL()" readonly hidden id="url"></textarea>
        <p id="copied-text" class="hidden">Copied!</p>
      </div>
    </div>
    <script>
      const pointRadius = 3;
      const codingStr = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';

      const canvas = document.getElementById('square');
      const pointCount = document.getElementById('point-count');
      const tensionInput = document.getElementById('tension');
      const pre = document.getElementById('url');
      const copiedAlert = document.getElementById('copied-text');

      const ctx = canvas.getContext("2d");
      let points = [
        50, 50,
        270, 50,
        270, 270
      ];

      let currentPoint = -1;

      ctx.translate(0.5, 0.5);
      ctx.lineJoin = 'round';

      function redraw() {
        pointCount.textContent = String(points.length / 2);
        ctx.clearRect(-1, -1, canvas.width + 2, canvas.height + 2);

        const tension = 1 - Number(tensionInput.value);

        ctx.beginPath();
        ctx.moveTo(points[0], points[1]);
        ctx.curve(points, tension, 25, true);
        ctx.closePath();

        ctx.strokeStyle = 'yellow';
        ctx.lineWidth = pointRadius;
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.fill();
        ctx.stroke();

        ctx.lineWidth = 1;
        for (let i = 0; i < points.length; i += 2) {
          ctx.strokeStyle = 'black';
          ctx.strokeRect(
            points[i] - pointRadius,
            points[i + 1] - pointRadius,
            pointRadius * 2,
            pointRadius * 2
          );
        }
      }

      function getPointAt(x, y) {
        for (let i = 0; i < points.length; i += 2) {
          // give a lot of leniency for mobile users
          if (
            Math.abs(points[i] - x) <= 4 * pointRadius &&
            Math.abs(points[i + 1] - y) <= 4 * pointRadius
          )
            return i; 
        }
        return -1;
      }

      function getPosition(event) {
        const rect = canvas.getBoundingClientRect();
        let x, y;

        if (event.touches && event.touches.length > 1) {
          x = NaN;
          y = NaN;
        } else {
          x = (event.clientX ?? event.touches[0].clientX) - rect.left;
          y = (event.clientY ?? event.touches[0].clientY) - rect.top;
        }

        return { x, y };
      }

      function addPoint() {
        points.push(160, 160);
        redraw();
      }

      function removePoint() {
        points.pop(); points.pop();
        redraw();
      }

      canvas.ontouchstart = canvas.onmousedown = event => {
        const pos = getPosition(event);
        currentPoint = getPointAt(pos.x, pos.y);
      };
      canvas.ontouchmove = canvas.onmousemove = event => {
        if (currentPoint !== -1) {
          const pos = getPosition(event);
          points[currentPoint] = pos.x;
          points[currentPoint + 1] = pos.y;
          redraw();
        }
      };
      window.ontouchend = window.onmouseup = () => currentPoint = -1;

      function compressPoints(input) {
        return input.map(el => codingStr[Math.round(el * 63/320)]).join('');
      }

      function saveURL() {
        const baseURL = location.href.split('?')[0];
        const tension = Number(tensionInput.value);
        const base64Param = compressPoints(points) + codingStr[Math.round(tension * 63)];
        const newURL = `${baseURL}?s=${base64Param}`;
        history.pushState({}, '', newURL);
        pre.value = newURL;
        pre.cols = newURL.length;
        pre.hidden = false;
      }

      function loadState() {
        const params = new URLSearchParams(location.search);
        let str = params.get('s');
        if (str) {
          if (str.length % 2) {
            tensionInput.value = Math.round(codingStr.indexOf(str[str.length - 1]) * 100/63) / 100;
            str = str.substr(0, str.length - 1);
          }
          points = [...str].map(el => Math.round(codingStr.indexOf(el) * 320/63));
          return;
        }
        // Legacy tension + base64url points. Not generated, but still accepted.
        const pointsStr = params.get('points');
        if (pointsStr) points = JSON.parse(`[${atob(pointsStr)}]`);
        tensionInput.value = params.get('tension') ?? 0.5;
      }

      function copyURL() {
        pre.setSelectionRange?.(0, pre.value.length);
        navigator.clipboard.writeText(pre.value);
        copiedAlert.className = 'visible';
        setTimeout(() => copiedAlert.className = 'hidden');
      }

      loadState();
      redraw();
    </script>
  </body>
</html>
